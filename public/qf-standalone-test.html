<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>QueueFloater Standalone Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { height: 100%; margin: 0; background: #0b0b0f; color: #eee; font: 14px/1.3 system-ui, sans-serif; }
      .hud { position: fixed; inset: 16px; display: grid; gap: 8px; max-width: 720px; }
      input, button { padding: 8px; border-radius: 8px; border: 1px solid #333; background: #17171d; color: #eee; }
      label { opacity: 0.8; }
      pre { white-space: pre-wrap; }
      .hint { font-size: 12px; opacity: 0.7; }
    </style>
    <script src="/queue-floater-config.js"></script>
  </head>
  <body>
    <div class="hud">
      <label>Avatar URL (TikTok or any image)</label>
      <input id="avatar" value="https://p19-pu-sign-useast8.tiktokcdn-us.com/tos-useast5-avt-0068-tx/7fd17cea1f34121764a7b307ee952dc4~tplv-tiktokx-cropcenter:1080:1080.jpeg?dr=9640&refresh_token=9a7b12b8&x-expires=1756612800&x-signature=3YOiJSho8xmtWHDP2F1XBNSuMjk%3D&t=4d5b0474&ps=13740610&shp=a5d48078&shcp=81f88b70&idc=useast5" />

      <label>Track (accepts Spotify URI or open.spotify URL)</label>
      <input id="track" value="spotify:track:4NRXx6U3G3J3RkGfHh1Euh" />
      <div class="hint">Examples: spotify:track:4NRXx6U3G3J3RkGfHh1Euh or https://open.spotify.com/track/4NRXx6U3G3J3RkGfHh1Euh</div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btn-fetch">Test Floater (fetch)</button>
        <button id="btn-xhr">Test Floater (XHR)</button>
      </div>

      <pre id="log"></pre>
    </div>

    <script src="/queue-floater.js"></script>
    <script src="/queue-linker.js"></script>
    <script>
      (function () {
        const log = (...a) => {
          const el = document.getElementById('log');
          el.textContent += a.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ') + '\n';
          console.log(...a);
        };

        function proxy(u) {
          if (window.QUEUE_FLOATER_IMAGE_PROXY) {
            return window.QUEUE_FLOATER_IMAGE_PROXY + encodeURIComponent(u || '');
          }
          try {
            const url = new URL(u);
            const hostAndPath = url.host + url.pathname + (url.search || '');
            return 'https://images.weserv.nl/?url=' + encodeURIComponent(hostAndPath);
          } catch {
            return u;
          }
        }

        // Convert open.spotify URLs to spotify:track: URIs for the queue endpoint/linker
        function toSpotifyUri(input) {
          if (!input) return input;
          if (input.startsWith('spotify:')) return input;
          try {
            const u = new URL(input);
            if (u.hostname.endsWith('spotify.com')) {
              const parts = u.pathname.split('/').filter(Boolean);
              if (parts[0] === 'track' && parts[1]) return 'spotify:track:' + parts[1];
            }
          } catch {}
          return input;
        }

        log('QueueFloater present:', typeof window.QueueFloater);

        QueueFloater.setConfig({
          debug: true,
          proxyImages: true,
          proxy,
          chatLinkTTLms: 60000,
          recentChatWindowMs: 60000,
          color: '#22cc88'
        });

        function linkToAvatar() {
          const avatar = document.getElementById('avatar').value.trim();
          const proxied = proxy(avatar);
          QueueFloater.linkNextQueueTo({
            platform: 'tiktok',
            userId: '123',
            userName: 'Standalone Test',
            pfpUrl: proxied
          });
          log('linked to', { pfpUrl: proxied });
        }

        async function fireQueueViaFetch() {
          const raw = document.getElementById('track').value.trim();
          const uri = toSpotifyUri(raw);
          try {
            await fetch('https://api.spotify.com/v1/me/player/queue?uri=' + encodeURIComponent(uri), {
              method: 'POST',
              mode: 'no-cors'
            });
          } catch {}
          log('queue fired (fetch, no-cors) ->', uri);
        }

        function fireQueueViaXHR() {
          const raw = document.getElementById('track').value.trim();
          const uri = toSpotifyUri(raw);
          try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://api.spotify.com/v1/me/player/queue?uri=' + encodeURIComponent(uri), true);
            xhr.send();
          } catch {}
          log('queue fired (XHR) ->', uri);
        }

        document.getElementById('btn-fetch').addEventListener('click', async () => {
          linkToAvatar();
          await new Promise(r => setTimeout(r, 50));
          await fireQueueViaFetch();
        });

        document.getElementById('btn-xhr').addEventListener('click', () => {
          linkToAvatar();
          setTimeout(fireQueueViaXHR, 50);
        });
      })();
    </script>
  </body>
</html>