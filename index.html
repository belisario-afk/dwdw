<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>dwdw</title>

    <link rel="stylesheet" href="./style.css">
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />

    <!-- Build marker for cache-busting verification -->
    <meta name="build-version" content="2025-08-26-14" />
    <!-- Proxy URL for TikTok feature (and exposed to window.TIKTOK_PROXY_URL) -->
    <meta name="tiktok-proxy" content="https://dwdw-7a4i.onrender.com" />

    <!-- Inline preboot: ensures TIKTOK_PROXY_URL + intercepts Spotify audio-features before your bundle runs -->
    <script>
      (function () {
        // Set TikTok proxy early
        try {
          var m = document.querySelector('meta[name="tiktok-proxy"]');
          var u = (m && m.getAttribute('content')) || 'https://dwdw-7a4i.onrender.com';
          u = u.replace(/\/+$/, '');
          window.TIKTOK_PROXY_URL = u;
          try { localStorage.setItem('TIKTOK_PROXY_URL', u); } catch {}
        } catch {}

        // Intercept Spotify audio-features (both fetch and XHR)
        try {
          var isAF = function (url) {
            return typeof url === 'string' && url.indexOf('https://api.spotify.com/v1/audio-features') === 0;
          };

          if (!window.__AUDIO_FEATURES_INTERCEPTED) {
            // fetch
            var of = window.fetch && window.fetch.bind(window);
            if (of) {
              window.fetch = function (input, init) {
                try {
                  var url = (typeof input === 'string') ? input : (input && (input.url || input.toString())) || '';
                  if (isAF(url)) {
                    return Promise.resolve(new Response('{}', { status: 200, headers: { 'Content-Type': 'application/json' } }));
                  }
                } catch {}
                return of(input, init);
              };
            }

            // XHR (safety net)
            var OX = window.XMLHttpRequest;
            if (OX) {
              window.XMLHttpRequest = function XHRProxy() {
                var xhr = new OX();
                var silenced = false;
                var self = this;
                this.onreadystatechange = null; this.onload = null; this.onerror = null;
                this.readyState = 0; this.status = 0; this.responseText = ''; this.response = '';

                this.open = function (m, u, a, user, pass) {
                  silenced = isAF(String(u || ''));
                  if (silenced) {
                    self.readyState = 1;
                    if (typeof self.onreadystatechange === 'function') { try { self.onreadystatechange(); } catch {} }
                    return;
                  }
                  return xhr.open(m, u, a !== false, user, pass);
                };

                this.send = function (b) {
                  if (!silenced) return xhr.send(b);
                  setTimeout(function () {
                    self.status = 200;
                    self.responseText = '{}';
                    self.response = '{}';
                    self.readyState = 4;
                    if (typeof self.onreadystatechange === 'function') { try { self.onreadystatechange(); } catch {} }
                    if (typeof self.onload === 'function') { try { self.onload(); } catch {} }
                  }, 0);
                };

                this.setRequestHeader = function(){ if (!silenced) return xhr.setRequestHeader.apply(xhr, arguments); };
                this.getAllResponseHeaders = function(){ return silenced ? '' : xhr.getAllResponseHeaders(); };
                this.getResponseHeader = function(n){ return silenced ? null : xhr.getResponseHeader(n); };
                this.abort = function(){ if (!silenced) return xhr.abort(); };

                xhr.onreadystatechange = function () {
                  if (!silenced) {
                    try {
                      self.readyState = xhr.readyState;
                      self.status = xhr.status;
                      self.responseText = xhr.responseText;
                      self.response = xhr.response;
                    } catch {}
                    if (typeof self.onreadystatechange === 'function') { try { self.onreadystatechange(); } catch {} }
                  }
                };
                xhr.onload = function () { if (!silenced && typeof self.onload === 'function') { try { self.onload(); } catch {} } };
                xhr.onerror = function () { if (!silenced && typeof self.onerror === 'function') { try { self.onerror(); } catch {} } };

                Object.defineProperty(self, 'responseType', { get(){ return silenced ? '' : xhr.responseType; }, set(v){ if (!silenced) xhr.responseType = v; } });
                Object.defineProperty(self, 'withCredentials', { get(){ return silenced ? false : xhr.withCredentials; }, set(v){ if (!silenced) xhr.withCredentials = v; } });
                Object.defineProperty(self, 'timeout', { get(){ return silenced ? 0 : xhr.timeout; }, set(v){ if (!silenced) xhr.timeout = v; } });
              };
            }

            window.__AUDIO_FEATURES_INTERCEPTED = true;
          }
        } catch {}
      })();
    </script>

    <!-- External preboot served from public/ so Vite won't try to bundle it -->
    <script src="/preboot.js?v=2025-08-26-14"></script>

    <style>
      :root {
        --bg: #0b0b0f;
        --fg: #e8e8ef;
        --muted: #a0a0b2;
        --accent: #22cc88;
        --accent-2: #cc2288;

        /* HUD tokens */
        --hud-gap: clamp(8px, 1.8vmin, 14px);
        --hud-radius: clamp(10px, 2vmin, 14px);
        --hud-font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --hud-surface: rgba(11, 11, 15, 0.7);
        --hud-border: 1px solid rgba(255, 255, 255, 0.06);
        --hud-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);

        /* Safe areas */
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
      }

      html, body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font: var(--hud-font);
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
      }

      #canvas-host {
        position: fixed;
        inset: 0;
        overflow: hidden;
      }

      /* —— Toolbar / HUD — */
      .toolbar {
        position: fixed;
        top: max(12px, var(--safe-top));
        left: max(12px, var(--safe-left));
        right: max(12px, var(--safe-right));
        margin: 0 auto;

        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;

        background: var(--hud-surface);
        backdrop-filter: blur(12px) saturate(120%);
        border: var(--hud-border);
        border-radius: var(--hud-radius);
        box-shadow: var(--hud-shadow);
        z-index: 9999;
        pointer-events: auto;

        -webkit-tap-highlight-color: transparent;
      }

      .left, .center, .right {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }

      .left  { flex: 1 1 320px; justify-content: flex-start; }
      .center{ flex: 1 1 360px; justify-content: center; }
      .right { flex: 1 1 320px; justify-content: flex-end; }

      .left > *, .center > *, .right > * {
        flex: 0 0 auto;
        min-width: 0;
      }

      button,
      select,
      input[type="range"] {
        color: var(--fg);
        background: #1a1a21;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 6px 10px;
      }
      button { cursor: pointer; }
      button:disabled,
      select:disabled,
      input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .hidden { display: none !important; }
      .label { color: var(--muted); white-space: nowrap; }
      .label--long { color: var(--muted); white-space: nowrap; }
      .spacer { width: 8px; }
      .grow { flex: 1 1 auto; }
      #seek { width: min(38vw, 520px); }
      #volume { width: 110px; }

      #panels {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 200;
      }
      #panels .panel {
        pointer-events: auto;
        background: #121219;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 10px;
        color: var(--fg);
      }
      #panels .panel.hidden { display: none; }

      #screensaver {
        position: fixed;
        inset: 0;
        background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.8));
        opacity: 0;
        pointer-events: none;
        transition: opacity 300ms ease;
        z-index: 150;
      }
      #screensaver.active { opacity: 1; }

      @media (max-width: 768px) {
        .toolbar {
          top: auto;
          bottom: max(10px, var(--safe-bottom));
          left: max(10px, var(--safe-left));
          right: max(10px, var(--safe-right));
          justify-content: center;
          gap: 8px;
          padding: 10px;
          border-radius: calc(var(--hud-radius) + 2px);
        }
        .center { order: 1; justify-content: center; flex: 1 1 100%; }
        .left   { order: 2; justify-content: center; flex: 1 1 100%; }
        .right  { order: 3; justify-content: center; flex: 1 1 100%; }
        .left, .center, .right { flex-wrap: wrap; gap: 8px; }
        #seek { width: 100%; max-width: 100%; }
        #volume { width: min(55vw, 240px); }
        .label--long, #gpu-label, #fps-label { display: none !important; }
      }

      @media (max-width: 380px) {
        .toolbar { left: max(8px, var(--safe-left)); right: max(8px, var(--safe-right)); gap: 6px; padding: 8px; }
        #btn-crossfade, #btn-vj, #btn-quality, #btn-accessibility, #btn-record { display: none !important; }
      }

      @media (prefers-reduced-motion: reduce) {
        * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
      }
    </style>

    <!-- Vite entry: point at your source, not built outputs -->
    <script type="module" src="/src/main.ts"></script>
    <!-- If you keep a global CSS file under src/, let Vite process it -->
    <link rel="stylesheet" href="/src/style.css">
  </head>
  <body>
    <div id="canvas-host" aria-hidden="true"></div>

    <div class="toolbar" role="region" aria-label="Player controls">
      <div class="left">
        <button id="btn-login" title="Login with Spotify">Login</button>
        <button id="btn-logout" class="hidden" title="Logout">Logout</button>
        <span id="user-label" class="label" aria-live="polite"></span>
        <span class="spacer"></span>
        <label class="label label--long" for="device-picker">Device</label>
        <select id="device-picker" title="Playback device"></select>
      </div>

      <div class="center">
        <button id="btn-prev" title="Previous">⏮</button>
        <button id="btn-play" title="Play">▶</button>
        <button id="btn-pause" class="hidden" title="Pause">⏸</button>
        <button id="btn-next" title="Next">⏭</button>

        <input id="seek" type="range" min="0" max="1000" step="1" value="0" aria-label="Seek" />
        <span id="time-label" class="label">0:00 / 0:00</span>

        <label class="label" for="volume">Vol</label>
        <input id="volume" type="range" min="0" max="100" step="1" value="80" aria-label="Volume" />
      </div>

      <div class="right">
        <label class="label label--long" for="scene-select">Scene</label>
        <select id="scene-select" title="Scene">
          <option value="Auto">Auto</option>
          <option value="Particles">Particles</option>
          <option value="Tunnel">Tunnel</option>
          <option value="Terrain">Terrain</option>
          <option value="Typography">Typography</option>
          <option value="Lyric Lines">Lyric Lines</option>
          <option value="Beat Ball">Beat Ball</option>
          <option value="Flow Field">Flow Field</option>
          <option value="Neon Bars">Neon Bars</option>
          <option value="Stained Glass Voronoi">Stained Glass Voronoi</option>
          <option value="Emo Slashes">Emo Slashes</option>
        </select>

        <label class="label label--long" for="lyrics-font">Font</label>
        <select id="lyrics-font" title="Lyrics font">
          <option>Bebas Neue</option>
          <option>Bangers</option>
          <option>Black Ops One</option>
          <option>Pacifico</option>
          <option>Press Start 2P</option>
        </select>

        <button id="btn-crossfade" title="Crossfade visuals">Crossfade</button>
        <button id="btn-vj" title="Open VJ panel">VJ</button>
        <button id="btn-quality" title="Quality settings">Quality</button>
        <button id="btn-accessibility" title="Accessibility">Accessibility</button>
        <button id="btn-record" title="Record visuals">● Rec</button>
        <button id="btn-queue" title="Song Queue">Queue</button>
        <button id="btn-fullscreen" title="Fullscreen">⛶</button>

        <span id="gpu-label" class="label" title="Graphics device">GPU: —</span>
        <span id="fps-label" class="label" title="Frames per second">FPS: —</span>
      </div>
    </div>

    <div id="panels" aria-live="polite" aria-relevant="additions removals"></div>
    <div id="screensaver" aria-hidden="true"></div>

    <script>
      window.onSpotifyWebPlaybackSDKReady = window.onSpotifyWebPlaybackSDKReady || function() {};
    </script>
    <script src="https://sdk.scdn.co/spotify-player.js" async></script>

    <!-- Lyrics font switching logic (persists to localStorage) -->
    <script>
      (function () {
        const FONTS = {
          'Bebas Neue': "'Bebas Neue', Impact, system-ui, sans-serif",
          'Bangers': "'Bangers', 'Comic Sans MS', system-ui, cursive",
          'Black Ops One': "'Black Ops One', Impact, system-ui, sans-serif",
          'Pacifico': "'Pacifico', 'Brush Script MT', cursive",
          'Press Start 2P': "'Press Start 2P', 'VT323', monospace",
        };
        const KEY = 'lyrics-font-label';
        const select = document.getElementById('lyrics-font');

        function apply(label) {
          const stack = FONTS[label] || FONTS['Bebas Neue'];
          document.documentElement.style.setProperty('--lyrics-font', stack);
          try { localStorage.setItem(KEY, label); } catch (_) {}
        }

        try {
          const saved = localStorage.getItem(KEY);
          if (saved && Object.prototype.hasOwnProperty.call(FONTS, saved)) {
            select.value = saved;
            apply(saved);
          } else {
            apply(select.value);
          }
        } catch (_) {
          apply(select.value);
        }

        select.addEventListener('change', (e) => apply(e.target.value));
      })();
    </script>

  </body>
</html>