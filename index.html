<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#0b0b0f" />
    <meta name="color-scheme" content="dark light" />
    <meta name="description" content="dwdw — Spotify-reactive visualizer with scenes, lyrics, and live requests." />
    <title>dwdw</title>

    <!-- Favicons / Manifest (served by Vite from /public) -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <!-- Removed PNG icon to avoid 404; keep SVG only -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Fonts for lyrics overlay choices -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bangers&family=Bebas+Neue&family=Black+Ops+One&family=Pacifico&family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />

    <!-- App stylesheet -->
    <link rel="stylesheet" href="/style.css" />

    <style>
      :root {
        --bg: #0b0b0f;
        --fg: #e8e8ef;
        --muted: #a0a0b2;
        --hud-gap: clamp(8px, 1.8vmin, 14px);
        --hud-radius: clamp(10px, 2vmin, 14px);
        --hud-font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --hud-surface: rgba(11, 11, 15, 0.7);
        --hud-border: 1px solid rgba(255,255,255,0.06);
        --hud-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
      }
      html, body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font: var(--hud-font);
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
      }
      #canvas-host { position: fixed; inset: 0; overflow: hidden; }

      .toolbar {
        position: fixed;
        top: max(12px, var(--safe-top));
        left: max(12px, var(--safe-left));
        right: max(12px, var(--safe-right));
        margin: 0 auto;
        display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
        gap: 12px; padding: 10px 12px;
        background: var(--hud-surface);
        backdrop-filter: blur(12px) saturate(120%);
        border: var(--hud-border);
        border-radius: var(--hud-radius);
        box-shadow: var(--hud-shadow);
        z-index: 9999;
        pointer-events: auto;
        -webkit-tap-highlight-color: transparent;
      }
      .left, .center, .right { display: flex; align-items: center; gap: 8px; min-width: 0; }
      .left  { flex: 1 1 320px; justify-content: flex-start; }
      .center{ flex: 1 1 360px; justify-content: center; }
      .right { flex: 1 1 320px; justify-content: flex-end; }

      button, select, input[type="range"] {
        color: var(--fg);
        background: #1a1a21;
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px;
        padding: 6px 10px;
      }
      button { cursor: pointer; }
      button:disabled, select:disabled, input:disabled { opacity: 0.5; cursor: not-allowed; }
      .hidden { display: none !important; }
      .label { color: var(--muted); white-space: nowrap; }
      .spacer { width: 8px; }
      #seek { width: min(38vw, 520px); }
      #volume { width: 110px; }

      @media (max-width: 768px) {
        .toolbar {
          top: auto; bottom: max(10px, var(--safe-bottom));
          left: max(10px, var(--safe-left)); right: max(10px, var(--safe-right));
          justify-content: center; gap: 8px; padding: 10px; border-radius: calc(var(--hud-radius) + 2px);
        }
        .center { order: 1; justify-content: center; flex: 1 1 100%; }
        .left   { order: 2; justify-content: center; flex: 1 1 100%; }
        .right  { order: 3; justify-content: center; flex: 1 1 100%; }
        .left, .center, .right { flex-wrap: wrap; gap: 8px; }
        #seek { width: 100%; max-width: 100%; }
        #volume { width: min(55vw, 240px); }
      }
      @media (max-width: 380px) {
        .toolbar { left: max(8px, var(--safe-left)); right: max(8px, var(--safe-right)); gap: 6px; padding: 8px; }
        #btn-crossfade, #btn-vj, #btn-quality, #btn-accessibility, #btn-record { display: none !important; }
      }
      @media (prefers-reduced-motion: reduce) {
        * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
      }
    </style>

    <!-- App entry (Vite) and scenes -->
    <script type="module" src="/src/main.ts"></script>
    <script type="module" src="/src/scenes/custom-scenes.ts"></script>
    <!-- disabled: QueueFloater provides its own requests overlay -->
    <!-- <script type="module" src="/src/scenes/requests-scene.ts"></script> -->
    <!-- disabled: QueueFloater includes its own Spotify queue bridge -->
    <!-- <script type="module" src="/src/integrations/song-requests-bridge.ts"></script> -->
  </head>
  <body>
    <noscript>
      <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0b0b0f;color:#fff;">
        <p>This app requires JavaScript enabled.</p>
      </div>
    </noscript>

    <div id="canvas-host" aria-hidden="true"></div>

    <div class="toolbar" role="region" aria-label="Player controls">
      <div class="left">
        <button id="btn-login" title="Login with Spotify">Login</button>
        <button id="btn-logout" class="hidden" title="Logout">Logout</button>
        <span id="user-label" class="label" aria-live="polite"></span>
        <span class="spacer"></span>
        <label class="label" for="device-picker">Device</label>
        <select id="device-picker" title="Playback device"></select>
      </div>

      <div class="center">
        <button id="btn-prev" title="Previous">⏮</button>
        <button id="btn-play" title="Play">▶</button>
        <button id="btn-pause" class="hidden" title="Pause">⏸</button>
        <button id="btn-next" title="Next">⏭</button>

        <input id="seek" type="range" min="0" max="1000" step="1" value="0" aria-label="Seek" />
        <span id="time-label" class="label">0:00 / 0:00</span>

        <label class="label" for="volume">Vol</label>
        <input id="volume" type="range" min="0" max="100" step="1" value="80" aria-label="Volume" />
      </div>

      <div class="right">
        <label class="label" for="scene-select">Scene</label>
        <select id="scene-select" title="Scene"></select>

        <label class="label" for="lyrics-font">Font</label>
        <select id="lyrics-font" title="Lyrics font">
          <option>Bebas Neue</option>
          <option>Bangers</option>
          <option>Black Ops One</option>
          <option>Pacifico</option>
          <option>Press Start 2P</option>
        </select>

        <button id="btn-crossfade" title="Crossfade visuals">Crossfade</button>
        <button id="btn-vj" title="Open VJ panel">VJ</button>
        <button id="btn-quality" title="Quality settings">Quality</button>
        <button id="btn-accessibility" title="Accessibility">Accessibility</button>
        <button id="btn-record" title="Record visuals">● Rec</button>
        <button id="btn-queue" title="Song Queue">Queue</button>
        <button id="btn-fullscreen" title="Fullscreen">⛶</button>

        <span id="gpu-label" class="label" title="Graphics device">GPU: —</span>
        <span id="fps-label" class="label" title="Frames per second">FPS: —</span>
      </div>
    </div>

    <!-- Prevent reference errors before Spotify SDK loads -->
    <script>
      window.onSpotifyWebPlaybackSDKReady = window.onSpotifyWebPlaybackSDKReady || function () {};
    </script>
    <script src="https://sdk.scdn.co/spotify-player.js" async></script>

    <!-- Lyrics font preference handling -->
    <script>
      (function () {
        const FONTS = {
          "Bebas Neue": "'Bebas Neue', Impact, system-ui, sans-serif",
          Bangers: "'Bangers', 'Comic Sans MS', system-ui, cursive",
          "Black Ops One": "'Black Ops One', Impact, system-ui, sans-serif",
          Pacifico: "'Pacifico', 'Brush Script MT', cursive",
          "Press Start 2P": "'Press Start 2P', 'VT323', monospace",
        };
        const KEY = "lyrics-font-label";
        const select = document.getElementById("lyrics-font");
        function apply(label) {
          const stack = FONTS[label] || FONTS["Bebas Neue"];
          document.documentElement.style.setProperty("--lyrics-font", stack);
          try { localStorage.setItem(KEY, label); } catch {}
        }
        try {
          const saved = localStorage.getItem(KEY);
          if (saved && Object.prototype.hasOwnProperty.call(FONTS, saved)) {
            select.value = saved; apply(saved);
          } else {
            apply(select.value);
          }
        } catch { apply(select.value); }
        select.addEventListener("change", (e) => apply(e.target.value));
      })();
    </script>

    <!-- Scene dropdown only (director wires all buttons to prevent duplicates) -->
    <script>
      (function () {
        const BUILT_INS = [
          "Auto",
          "Lyric Lines",
          "Beat Ball",
          "Flow Field",
          "Neon Bars",
          "Stained Glass Voronoi",
          "Emo Slashes",
          "Requests Floaters",
        ];
        const sel = document.getElementById("scene-select");

        function externalScenes() {
          try {
            const d = window.__director;
            if (d && typeof d.listExternalSceneNames === "function") {
              return d.listExternalSceneNames() || [];
            }
          } catch {}
          return [];
        }

        function rebuildScenes() {
          if (!sel) return;
          const current = sel.value;
          const ext = externalScenes();
          const all = BUILT_INS.concat(ext.filter((n) => BUILT_INS.indexOf(n) < 0));
          sel.innerHTML = "";
          all.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
          });
          sel.value = all.indexOf(current) >= 0 ? current : "Auto";
        }

        rebuildScenes();
        const t = setInterval(() => {
          rebuildScenes();
          if (window.__director) clearInterval(t);
        }, 300);
        window.addEventListener("load", rebuildScenes);

        sel && sel.addEventListener("change", (e) => {
          const val = e.target && e.target.value ? String(e.target.value) : "Auto";
          try { window.__director && window.__director.requestScene(val); } catch {}
        });
      })();
    </script>

    <!-- Queue Floater overlay (served from your Cloudflare Worker) -->
    <script src="https://image-proxy.tikusers862.workers.dev/queue-floater.production.js"></script>
    <script>
      QueueFloater.setConfig({
        proxyImages: true,
        proxy: (u) => 'https://image-proxy.tikusers862.workers.dev/image-proxy?url=' + encodeURIComponent(u),
        color: '#22cc88'
        // debug: true
      });
    </script>
  </body>
</html>