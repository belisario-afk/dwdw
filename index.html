<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>dwdw</title>

    <link rel="icon" href="favicon.svg" type="image/svg+xml" />

    <!-- Bump this each deploy to force cache refresh -->
    <meta name="build-version" content="2025-08-26-13" />

    <!-- Backup source for the proxy URL used by your TikTok feature -->
    <meta name="tiktok-proxy" content="https://dwdw-7a4i.onrender.com" />

    <!-- Inline fallback preboot: guarantees TIKTOK_PROXY_URL + audio-features intercept even if external file fails -->
    <script>
      (function () {
        try {
          var m = document.querySelector('meta[name="tiktok-proxy"]');
          var u = (m && m.getAttribute('content')) || 'https://dwdw-7a4i.onrender.com';
          u = u.replace(/\/+$/, '');
          window.TIKTOK_PROXY_URL = u;
          try { localStorage.setItem('TIKTOK_PROXY_URL', u); } catch {}
        } catch {}

        // Minimal, idempotent audio-features intercept (fetch + XHR)
        try {
          var isAF = function (url) { return typeof url === 'string' && url.indexOf('https://api.spotify.com/v1/audio-features') === 0; };

          if (!window.__AUDIO_FEATURES_INTERCEPTED) {
            var of = window.fetch && window.fetch.bind(window);
            if (of) {
              window.fetch = function (input, init) {
                try {
                  var url = (typeof input === 'string') ? input : (input && (input.url || input.toString())) || '';
                  if (isAF(url)) {
                    return Promise.resolve(new Response('{}', { status: 200, headers: { 'Content-Type': 'application/json' } }));
                  }
                } catch {}
                return of(input, init);
              };
            }

            var OX = window.XMLHttpRequest;
            if (OX) {
              window.XMLHttpRequest = function XHRProxy() {
                var xhr = new OX();
                var silenced = false;
                var self = this;
                this.onreadystatechange = null; this.onload = null; this.onerror = null;
                this.readyState = 0; this.status = 0; this.responseText = ''; this.response = '';
                this.open = function (m, u, a, user, pass) {
                  silenced = isAF(String(u||''));
                  if (silenced) { self.readyState = 1; if (typeof self.onreadystatechange==='function') { try{ self.onreadystatechange(); }catch{} } return; }
                  return xhr.open(m, u, a!==false, user, pass);
                };
                this.send = function (b) {
                  if (!silenced) return xhr.send(b);
                  setTimeout(function () {
                    self.status=200; self.responseText='{}'; self.response='{}'; self.readyState=4;
                    if (typeof self.onreadystatechange==='function') { try{ self.onreadystatechange(); }catch{} }
                    if (typeof self.onload==='function') { try{ self.onload(); }catch{} }
                  }, 0);
                };
                this.setRequestHeader = function(){ if(!silenced) return xhr.setRequestHeader.apply(xhr, arguments); };
                this.getAllResponseHeaders = function(){ return silenced ? '' : xhr.getAllResponseHeaders(); };
                this.getResponseHeader = function(n){ return silenced ? null : xhr.getResponseHeader(n); };
                this.abort = function(){ if(!silenced) return xhr.abort(); };
                xhr.onreadystatechange = function(){ if(!silenced){ try{ self.readyState=xhr.readyState; self.status=xhr.status; self.responseText=xhr.responseText; self.response=xhr.response; }catch{} if(typeof self.onreadystatechange==='function'){ try{ self.onreadystatechange(); }catch{} } } };
                xhr.onload = function(){ if(!silenced && typeof self.onload==='function'){ try{ self.onload(); }catch{} } };
                xhr.onerror = function(){ if(!silenced && typeof self.onerror==='function'){ try{ self.onerror(); }catch{} } };
                Object.defineProperty(self,'responseType',{ get(){ return silenced?'':xhr.responseType;}, set(v){ if(!silenced) xhr.responseType=v; }});
                Object.defineProperty(self,'withCredentials',{ get(){ return silenced?false:xhr.withCredentials;}, set(v){ if(!silenced) xhr.withCredentials=v; }});
                Object.defineProperty(self,'timeout',{ get(){ return silenced?0:xhr.timeout;}, set(v){ if(!silenced) xhr.timeout=v; }});
              };
            }

            window.__AUDIO_FEATURES_INTERCEPTED = true;
          }
        } catch {}
      })();
    </script>

    <!-- External preboot: idempotent; adds filters and a backup intercept if inline failed -->
    <script src="preboot.js?v=2025-08-26-13"></script>

    <style>
      :root {
        --bg: #0b0b0f; --fg: #e8e8ef; --muted: #a0a0b2;
        --hud-surface: rgba(11, 11, 15, 0.7); --hud-border: 1px solid rgba(255, 255, 255, 0.06);
        --hud-radius: 12px; --hud-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
        --safe-top: env(safe-area-inset-top, 0px); --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-left: env(safe-area-inset-left, 0px);
      }
      html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow: hidden; -webkit-text-size-adjust: 100%; }
      #canvas-host { position: fixed; inset: 0; overflow: hidden; }

      .toolbar {
        position: fixed; top: max(12px, var(--safe-top)); left: max(12px, var(--safe-left)); right: max(12px, var(--safe-right)); margin: 0 auto;
        display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px;
        background: var(--hud-surface); backdrop-filter: blur(12px) saturate(120%); border: var(--hud-border); border-radius: var(--hud-radius); box-shadow: var(--hud-shadow);
        z-index: 9999; pointer-events: auto; -webkit-tap-highlight-color: transparent;
      }
      .left, .center, .right { display: flex; align-items: center; gap: 8px; min-width: 0; }
      .left  { flex: 1 1 320px; justify-content: flex-start; }
      .center{ flex: 1 1 360px; justify-content: center; }
      .right { flex: 1 1 320px; justify-content: flex-end; }
      button, select, input[type="range"] { color: var(--fg); background: #1a1a21; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 6px 10px; }
      button { cursor: pointer; }
      .hidden { display: none !important; }
      .label { color: var(--muted); white-space: nowrap; }
      #seek { width: min(38vw, 520px); } #volume { width: 110px; }

      #panels { position: fixed; right: 0; top: 0; bottom: 0; pointer-events: none; z-index: 200; }
      #panels .panel { pointer-events: auto; background: #121219; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 10px; color: var(--fg); }

      #screensaver { position: fixed; inset: 0; background: radial-gradient(ellipse at center, rgba(0,0,0,0.35), rgba(0,0,0,0.8)); opacity: 0; pointer-events: none; transition: opacity 300ms ease; z-index: 150; }
      #screensaver.active { opacity: 1; }

      @media (max-width: 768px) {
        .toolbar { top: auto; bottom: max(10px, var(--safe-bottom)); left: max(10px, var(--safe-left)); right: max(10px, var(--safe-right));
          justify-content: center; gap: 8px; padding: 10px; border-radius: 14px; }
        .center { order: 1; flex: 1 1 100%; } .left { order: 2; flex: 1 1 100%; } .right { order: 3; flex: 1 1 100%; }
        #seek { width: 100%; } #volume { width: min(55vw, 240px); }
      }
      @media (max-width: 380px) {
        .toolbar { left: max(8px, var(--safe-left)); right: max(8px, var(--safe-right)); gap: 6px; padding: 8px; }
        #btn-crossfade,#btn-vj,#btn-quality,#btn-accessibility,#btn-record { display:none!important; }
      }
    </style>
  </head>
  <body>
    <div id="canvas-host" aria-hidden="true"></div>

    <div class="toolbar" role="region" aria-label="Player controls">
      <div class="left">
        <button id="btn-login" title="Login with Spotify">Login</button>
        <button id="btn-logout" class="hidden" title="Logout">Logout</button>
        <span id="user-label" class="label" aria-live="polite"></span>
        <label class="label" for="device-picker">Device</label>
        <select id="device-picker" title="Playback device"></select>
      </div>

      <div class="center">
        <button id="btn-prev" title="Previous">⏮</button>
        <button id="btn-play" title="Play">▶</button>
        <button id="btn-pause" class="hidden" title="Pause">⏸</button>
        <button id="btn-next" title="Next">⏭</button>
        <input id="seek" type="range" min="0" max="1000" step="1" value="0" aria-label="Seek" />
        <span id="time-label" class="label">0:00 / 0:00</span>
        <label class="label" for="volume">Vol</label>
        <input id="volume" type="range" min="0" max="100" step="1" value="80" aria-label="Volume" />
      </div>

      <div class="right">
        <label class="label" for="scene-select">Scene</label>
        <select id="scene-select" title="Scene">
          <option>Auto</option><option>Particles</option><option>Tunnel</option><option>Terrain</option><option>Typography</option>
          <option>Lyric Lines</option><option>Beat Ball</option><option>Flow Field</option><option>Neon Bars</option><option>Stained Glass Voronoi</option><option>Emo Slashes</option>
        </select>
        <button id="btn-crossfade" title="Crossfade visuals">Crossfade</button>
        <button id="btn-vj" title="Open VJ panel">VJ</button>
        <button id="btn-quality" title="Quality settings">Quality</button>
        <button id="btn-accessibility" title="Accessibility">Accessibility</button>
        <button id="btn-record" title="Record visuals">● Rec</button>
        <button id="btn-queue" title="Song Queue">Queue</button>
        <button id="btn-fullscreen" title="Fullscreen">⛶</button>
        <span id="gpu-label" class="label" title="Graphics device">GPU: —</span>
        <span id="fps-label" class="label" title="Frames per second">FPS: —</span>
      </div>
    </div>

    <div id="panels" aria-live="polite" aria-relevant="additions removals"></div>
    <div id="screensaver" aria-hidden="true"></div>

    <script>
      window.onSpotifyWebPlaybackSDKReady = window.onSpotifyWebPlaybackSDKReady || function() {};
    </script>
    <script src="https://sdk.scdn.co/spotify-player.js" async></script>

    <!-- Use a relative path so it works under /dwdw/ in GitHub Pages -->
    <script type="module" src="src/main.ts?v=2025-08-26-13"></script>
  </body>
</html>