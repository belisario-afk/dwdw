<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>dwdw</title>

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- Bump this when you deploy to verify you're seeing the new HTML -->
    <meta name="build-version" content="2025-08-26-02" />

    <!-- Backup source for the proxy URL -->
    <meta name="tiktok-proxy" content="https://dwdw-7a4i.onrender.com" />

    <!-- EARLY: Define the proxy URL and persist it so it's available immediately and after reloads -->
    <script>
      (function () {
        try {
          var u = 'https://dwdw-7a4i.onrender.com'.replace(/\/+$/, '');
          window.TIKTOK_PROXY_URL = u;
          try { localStorage.setItem('TIKTOK_PROXY_URL', u); } catch {}
        } catch {}
      })();
    </script>

    <!-- EARLY: Silence Spotify audio-features 403s by intercepting before the network -->
    <script>
      (function () {
        try {
          var shouldSilence = function (url) {
            return typeof url === 'string' && url.indexOf('https://api.spotify.com/v1/audio-features') === 0;
          };

          // Patch fetch
          var origFetch = window.fetch && window.fetch.bind(window);
          if (origFetch) {
            window.fetch = function (input, init) {
              try {
                var url = (typeof input === 'string')
                  ? input
                  : (input && (input.url || input.toString())) || '';
                if (shouldSilence(url)) {
                  return Promise.resolve(new Response('{}', {
                    status: 200,
                    headers: { 'Content-Type': 'application/json' }
                  }));
                }
              } catch {}
              return origFetch(input, init);
            };
          }

          // Optional: Patch XMLHttpRequest as a safety net (many apps only use fetch)
          var OrigXHR = window.XMLHttpRequest;
          if (OrigXHR) {
            function XHRProxy() {
              var xhr = new OrigXHR();
              var _url = '';
              var _silenced = false;
              var self = this;

              // Mirror properties
              this.readyState = 0;
              this.status = 0;
              this.responseText = '';
              this.response = '';
              this.onreadystatechange = null;
              this.onload = null;
              this.onerror = null;

              this.open = function (method, url, async, user, password) {
                _url = String(url || '');
                _silenced = shouldSilence(_url);
                if (_silenced) {
                  // Simulate opened
                  self.readyState = 1;
                  if (typeof self.onreadystatechange === 'function') { try { self.onreadystatechange(); } catch {} }
                } else {
                  return xhr.open(method, url, async !== false, user, password);
                }
              };

              this.send = function (body) {
                if (!_silenced) return xhr.send(body);
                // Synthesize a successful, empty JSON response
                setTimeout(function () {
                  self.status = 200;
                  self.responseText = '{}';
                  self.response = '{}';
                  self.readyState = 4;
                  if (typeof self.onreadystatechange === 'function') { try { self.onreadystatechange(); } catch {} }
                  if (typeof self.onload === 'function') { try { self.onload(); } catch {} }
                }, 0);
              };

              // Pass-through for headers and others (no-ops for silenced requests)
              this.setRequestHeader = function () {
                if (!_silenced) return xhr.setRequestHeader.apply(xhr, arguments);
              };
              this.getAllResponseHeaders = function () {
                return _silenced ? '' : xhr.getAllResponseHeaders();
              };
              this.getResponseHeader = function (name) {
                return _silenced ? null : xhr.getResponseHeader(name);
              };
              this.abort = function () {
                if (!_silenced) return xhr.abort();
              };

              // Event forwarding for non-silenced XHRs
              xhr.onreadystatechange = function () {
                // Mirror dynamic props for non-silenced flows
                if (!_silenced) {
                  try {
                    self.readyState = xhr.readyState;
                    self.status = xhr.status;
                    self.responseText = xhr.responseText;
                    self.response = xhr.response;
                  } catch {}
                  if (typeof self.onreadystatechange === 'function') { try { self.onreadystatechange(); } catch {} }
                }
              };
              xhr.onload = function () {
                if (!_silenced && typeof self.onload === 'function') { try { self.onload(); } catch {} }
              };
              xhr.onerror = function () {
                if (!_silenced && typeof self.onerror === 'function') { try { self.onerror(); } catch {} }
              };

              // Property proxies
              Object.defineProperty(self, 'responseType', {
                get: function () { return _silenced ? '' : xhr.responseType; },
                set: function (v) { if (!_silenced) xhr.responseType = v; }
              });
              Object.defineProperty(self, 'withCredentials', {
                get: function () { return _silenced ? false : xhr.withCredentials; },
                set: function (v) { if (!_silenced) xhr.withCredentials = v; }
              });
              Object.defineProperty(self, 'timeout', {
                get: function () { return _silenced ? 0 : xhr.timeout; },
                set: function (v) { if (!_silenced) xhr.timeout = v; }
              });
            }
            XHRProxy.DONE = OrigXHR.DONE;
            XHRProxy.HEADERS_RECEIVED = OrigXHR.HEADERS_RECEIVED;
            XHRProxy.LOADING = OrigXHR.LOADING;
            XHRProxy.OPENED = OrigXHR.OPENED;
            XHRProxy.UNSENT = OrigXHR.UNSENT;
            window.XMLHttpRequest = XHRProxy;
          }
        } catch {}
      })();
    </script>

    <style>
      :root {
        --bg: #0b0b0f;
        --fg: #e8e8ef;
        --muted: #a0a0b2;
        --accent: #22cc88;
        --accent-2: #cc2288;

        --hud-gap: clamp(8px, 1.8vmin, 14px);
        --hud-radius: clamp(10px, 2vmin, 14px);
        --hud-font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        --hud-surface: rgba(11, 11, 15, 0.7);
        --hud-border: 1px solid rgba(255, 255, 255, 0.06);
        --hud-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);

        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
      }

      html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font: var(--hud-font); overflow: hidden; -webkit-text-size-adjust: 100%; }
      #canvas-host { position: fixed; inset: 0; overflow: hidden; }

      .toolbar {
        position: fixed; top: max(12px, var(--safe-top)); left: max(12px, var(--safe-left)); right: max(12px, var(--safe-right)); margin: 0 auto;
        display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
        gap: 12px; padding: 10px 12px;
        background: var(--hud-surface); backdrop-filter: blur(12px) saturate(120%);
        border: var(--hud-border); border-radius: var(--hud-radius); box-shadow: var(--hud-shadow);
        z-index: 9999; pointer-events: auto; -webkit-tap-highlight-color: transparent;
      }

      .left, .center, .right { display: flex; align-items: center; gap: 8px; min-width: 0; }
      .left  { flex: 1 1 320px; justify-content: flex-start; }
      .center{ flex: 1 1 360px; justify-content: center; }
      .right { flex: 1 1 320px; justify-content: flex-end; }
      .left > *, .center > *, .right > * { flex: 0 0 auto; min-width: 0; }

      button, select, input[type="range"] { color: var(--fg); background: #1a1a21; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 6px 10px; }
      button { cursor: pointer; }
      button:disabled, select:disabled, input:disabled { opacity: 0.5; cursor: not-allowed; }

      .hidden { display: none !important; }
      .label { color: var(--muted); white-space: nowrap; }
      .label--long { color: var(--muted); white-space: nowrap; }
      .spacer { width: 8px; }
      .grow { flex: 1 1 auto; }
      #seek { width: min(38vw, 520px); }
      #volume { width: 110px; }

      #panels { position: fixed; right: 0; top: 0; bottom: 0; pointer-events: none; z-index: 200; }
      #panels .panel { pointer-events: auto; background: #121219; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 10px; padding: 10px; color: var(--fg); }

      #screensaver { position: fixed; inset: 0; background: radial-gradient(ellipse at center, rgba(0,0,0,0.35), rgba(0,0,0,0.8)); opacity: 0; pointer-events: none; transition: opacity 300ms ease; z-index: 150; }
      #screensaver.active { opacity: 1; }

      @media (max-width: 768px) {
        .toolbar { top: auto; bottom: max(10px, var(--safe-bottom)); left: max(10px, var(--safe-left)); right: max(10px, var(--safe-right)); justify-content: center; gap: 8px; padding: 10px; border-radius: calc(var(--hud-radius) + 2px); }
        .center { order: 1; justify-content: center; flex: 1 1 100%; }
        .left   { order: 2; justify-content: center; flex: 1 1 100%; }
        .right  { order: 3; justify-content: center; flex: 1 1 100%; }
        .left, .center, .right { flex-wrap: wrap; gap: 8px; }
        #seek { width: 100%; max-width: 100%; }
        #volume { width: min(55vw, 240px); }
        .label--long, #gpu-label, #fps-label { display: none !important; }
      }

      @media (max-width: 380px) {
        .toolbar { left: max(8px, var(--safe-left)); right: max(8px, var(--safe-right)); gap: 6px; padding: 8px; }
        #btn-crossfade, #btn-vj, #btn-quality, #btn-accessibility, #btn-record { display: none !important; }
      }
    </style>
  </head>
  <body>
    <div id="canvas-host" aria-hidden="true"></div>

    <div class="toolbar" role="region" aria-label="Player controls">
      <div class="left">
        <button id="btn-login" title="Login with Spotify">Login</button>
        <button id="btn-logout" class="hidden" title="Logout">Logout</button>
        <span id="user-label" class="label" aria-live="polite"></span>
        <span class="spacer"></span>
        <label class="label label--long" for="device-picker">Device</label>
        <select id="device-picker" title="Playback device"></select>
      </div>

      <div class="center">
        <button id="btn-prev" title="Previous">⏮</button>
        <button id="btn-play" title="Play">▶</button>
        <button id="btn-pause" class="hidden" title="Pause">⏸</button>
        <button id="btn-next" title="Next">⏭</button>

        <input id="seek" type="range" min="0" max="1000" step="1" value="0" aria-label="Seek" />
        <span id="time-label" class="label">0:00 / 0:00</span>

        <label class="label" for="volume">Vol</label>
        <input id="volume" type="range" min="0" max="100" step="1" value="80" aria-label="Volume" />
      </div>

      <div class="right">
        <label class="label label--long" for="scene-select">Scene</label>
        <select id="scene-select" title="Scene">
          <option value="Auto">Auto</option>
          <option value="Particles">Particles</option>
          <option value="Tunnel">Tunnel</option>
          <option value="Terrain">Terrain</option>
          <option value="Typography">Typography</option>
          <option value="Lyric Lines">Lyric Lines</option>
          <option value="Beat Ball">Beat Ball</option>
          <option value="Flow Field">Flow Field</option>
          <option value="Neon Bars">Neon Bars</option>
          <option value="Stained Glass Voronoi">Stained Glass Voronoi</option>
          <option value="Emo Slashes">Emo Slashes</option>
        </select>

        <label class="label label--long" for="lyrics-font">Font</label>
        <select id="lyrics-font" title="Lyrics font">
          <option>Bebas Neue</option>
          <option>Bangers</option>
          <option>Black Ops One</option>
          <option>Pacifico</option>
          <option>Press Start 2P</option>
        </select>

        <button id="btn-crossfade" title="Crossfade visuals">Crossfade</button>
        <button id="btn-vj" title="Open VJ panel">VJ</button>
        <button id="btn-quality" title="Quality settings">Quality</button>
        <button id="btn-accessibility" title="Accessibility">Accessibility</button>
        <button id="btn-record" title="Record visuals">● Rec</button>
        <button id="btn-queue" title="Song Queue">Queue</button>
        <button id="btn-fullscreen" title="Fullscreen">⛶</button>

        <span id="gpu-label" class="label" title="Graphics device">GPU: —</span>
        <span id="fps-label" class="label" title="Frames per second">FPS: —</span>
      </div>
    </div>

    <div id="panels" aria-live="polite" aria-relevant="additions removals"></div>
    <div id="screensaver" aria-hidden="true"></div>

    <script>
      window.onSpotifyWebPlaybackSDKReady = window.onSpotifyWebPlaybackSDKReady || function() {};
    </script>
    <script src="https://sdk.scdn.co/spotify-player.js" async></script>

    <!-- Cache-bust to ensure browsers fetch the latest bundle -->
    <script type="module" src="/src/main.ts?v=2025-08-26-02"></script>
  </body>
</html>